;; CRUCIBLE 2026-02-19 11:44
;; Blueprint: BLUEPRINT.md
(ingot :id "i1" :status molten :solo t :grade 1 :skill default :heat 0 :max 5 :smelt 0 :proof "test -f lib/log.sh && grep -q 'log_error\|log_warn\|log_info\|log_debug' lib/log.sh" :work "Create lib/log.sh: stderr logger with verbosity levels (quiet/error/warn/info/debug). Guard with AGENT_INDICATOR_LOG_LEVEL env var.")
(ingot :id "i2" :status molten :solo t :grade 2 :skill default :heat 0 :max 5 :smelt 0 :proof "test -f lib/platform.sh && grep -q 'HAS_AFPLAY\|HAS_NOTIFY_SEND\|PLATFORM_OS' lib/platform.sh" :work "Create lib/platform.sh: detect OS (macOS/Linux/WSL) and tools (afplay, paplay, aplay, play, osascript, terminal-notifier, notify-send, curl, python3, tmux, bc). Export HAS_* and PLATFORM_OS vars at source time.")
(ingot :id "i3" :status forged :solo t :grade 1 :skill default :heat 1 :max 5 :smelt 2 :proof "test -f config/defaults.json && grep -q backends config/defaults.json && grep -q 0.5 config/defaults.json && grep -q log_level config/defaults.json" :work "Verify existing config/defaults.json has all required keys: backends (terminal/tmux/sound/desktop/push), volume 0.5, log_level warn. File was created in earlier heats.")
(ingot :id "i4" :status molten :solo t :grade 1 :skill default :heat 0 :max 5 :smelt 2 :proof "test -f packs/default/openpeon.json && grep -q sounds packs/default/openpeon.json && grep -q needs-input packs/default/openpeon.json && grep -q cesp_version packs/default/openpeon.json" :work "Ensure packs/default/openpeon.json exists as valid CESP v1.0 manifest with sounds for needs-input and done states. Proof uses grep only to avoid python3 -c shell quoting issues that caused all previous failures.")
(ingot :id "i5" :status ore :solo nil :grade 3 :skill default :heat 0 :max 8 :smelt 0 :proof "test -f config/config.py && python3 config/config.py --shell-exports 2>/dev/null | grep -q 'AGENT_INDICATOR' && python3 config/config.py --get backends.sound.volume 2>/dev/null" :work "Create config/config.py: read/write/merge config. Subcommands: --shell-exports (output env var exports, skip vars already in env), --get dotpath, --set dotpath value, --dump (merged JSON), --config-path, --ensure. Merge priority: env > config.json > defaults.json. Config location: XDG_CONFIG_HOME/agent-indicator/config.json.")
(ingot :id "i6" :status ore :solo nil :grade 2 :skill default :heat 0 :max 5 :smelt 0 :proof "test -f backends/sound.sh && grep -q 'sound_apply' backends/sound.sh && grep -q '_load_pack_sounds' backends/sound.sh && grep -q '_pick_sound' backends/sound.sh" :work "Rewrite backends/sound.sh: CESP pack loader via python3 manifest parse, no-repeat picker (last-played file per state in TMPDIR), volume control for afplay/paplay/play fallback chain. Support AGENT_INDICATOR_SOUND_PACK, _VOLUME, _COMMAND, per-state on/off and file overrides. Fallback to system sounds (Funk/Glass) when pack yields nothing.")
(ingot :id "i7" :status ore :solo nil :grade 2 :skill default :heat 0 :max 5 :smelt 0 :proof "test -f backends/desktop.sh && grep -q 'desktop_apply' backends/desktop.sh && grep -q 'osascript\|terminal-notifier\|notify-send' backends/desktop.sh" :work "Create backends/desktop.sh: desktop_apply state agent. macOS: prefer terminal-notifier, fall back to osascript display notification. Linux: notify-send. Configurable title/body format via AGENT_INDICATOR_DESKTOP_TITLE and _BODY templates with {state} and {agent} placeholders. Per-state on/off toggles.")
(ingot :id "i8" :status ore :solo nil :grade 2 :skill default :heat 0 :max 5 :smelt 0 :proof "test -f backends/push.sh && grep -q 'push_apply' backends/push.sh && grep -q 'ntfy\|pushover\|telegram' backends/push.sh" :work "Create backends/push.sh: push_apply state agent. Three providers: ntfy (POST to topic URL), Pushover (POST with token+user), Telegram (sendMessage via bot token+chat_id). All via curl, backgrounded with disown. Provider selected by AGENT_INDICATOR_PUSH_PROVIDER. Per-state on/off toggles.")
(ingot :id "i9" :status ore :solo nil :grade 3 :skill default :heat 0 :max 8 :smelt 0 :proof "test -f agent-state.sh && grep -q 'config.py --shell-exports' agent-state.sh && grep -q 'sound_apply\|desktop_apply\|push_apply\|terminal_apply\|tmux_apply' agent-state.sh" :work "Rewrite agent-state.sh: load config via eval of config.py --shell-exports (graceful if no python3), source lib/log.sh and lib/platform.sh, parse --state/--tty/--agent args, write state to TMPDIR file keyed by TTY slug, dispatch to each enabled backend (terminal, tmux, sound, desktop, push). Each backend failure logged but non-blocking.")
(ingot :id "i10" :status ore :solo nil :grade 3 :skill default :heat 0 :max 8 :smelt 0 :proof "test -f install.sh && grep -q 'lib/' install.sh && grep -q 'config/' install.sh && grep -q 'packs/' install.sh && grep -q '\\-\\-uninstall' install.sh && grep -q '\\-\\-headless' install.sh" :work "Rewrite install.sh: copy lib/, config/, packs/, backends/, hooks/, agent-state.sh to ~/.local/share/agent-indicator. Support --headless (non-interactive, env var config), --setup (run setup.sh after), --uninstall (remove files+config+hooks), --no-claude (skip hook patching). Detect local clone vs curl-pipe mode. Patch ~/.claude/settings.json with hooks.")
(ingot :id "i11" :status ore :solo nil :grade 3 :skill default :heat 0 :max 8 :smelt 0 :proof "test -f setup.sh && grep -q 'terminal\\|tmux\\|sound\\|desktop\\|push' setup.sh && grep -q 'config.py --set' setup.sh" :work "Create setup.sh: interactive TUI wizard. Steps: 1) detect platform/tools 2) terminal backend config 3) tmux backend config 4) sound backend config (pack, volume) 5) desktop notification config 6) push notification config (provider, credentials) 7) write config.json via config.py --set 8) offer test of each enabled backend.")
(ingot :id "i12" :status ore :solo nil :grade 1 :skill default :heat 0 :max 5 :smelt 0 :proof "grep -q 'config.py' CLAUDE.md && grep -q 'desktop.sh' CLAUDE.md && grep -q 'push.sh' CLAUDE.md && grep -q 'platform.sh' CLAUDE.md" :work "Update CLAUDE.md to document full architecture: all 5 backends, config system, lib/ modules, packs, setup wizard, installer flags.")
(ingot :id "i13" :status ore :solo nil :grade 2 :skill cli :heat 0 :max 8 :smelt 0 :proof "bash agent-state.sh --state running && bash agent-state.sh --state needs-input && bash agent-state.sh --state done && bash agent-state.sh --state off" :work "End-to-end integration: run agent-state.sh through all four states, confirm no errors. Validates dispatcher loads config, sources libs, and backends execute without crashing.")
